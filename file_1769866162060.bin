/**
 * Catbox Uploader Plugin (CJS)
 * Command: .tourl
 * Creator: Kyzo Yamada
 */

const fs = require("fs");
const axios = require("axios");
const FormData = require("form-data");

async function CatBox(filePath) {
  try {
    const fileStream = fs.createReadStream(filePath)
    const formData = new FormData()

    formData.append("fileToUpload", fileStream)
    formData.append("reqtype", "fileupload")
    formData.append("userhash", "")

    const response = await axios.post(
      "https://catbox.moe/user/api.php",
      formData,
      { headers: formData.getHeaders() }
    )

    return response.data
  } catch (error) {
    console.error("Catbox Upload Error:", error)
    return null
  }
}

let handler = async (m, { conn, quoted, mimetype }) => {
  if (!quoted) return m.reply("âŒ Reply media!")
  if (!/image|video|audio/.test(mimetype))
    return m.reply("âŒ Reply foto/video/audio!")

  m.reply("â³ Uploading to Catbox...")

  try {
    const media = await conn.downloadAndSaveMediaMessage(quoted)
    const url = await CatBox(media)

    if (!url) return m.reply("âŒ Upload gagal!")

    await conn.sendMessage(
      m.chat,
      { text: `âœ… *Upload Berhasil!*\n\nğŸŒ URL:\n${url}` },
      { quoted: m }
    )

    fs.unlinkSync(media)
  } catch (e) {
    console.error(e)
    m.reply("âŒ Error: " + e.message)
  }
}

handler.help = ["tourl"]
handler.tags = ["tools"]
handler.command = /^(tourl|catbox)$/i

module.exports = handler