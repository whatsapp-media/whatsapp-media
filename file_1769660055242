import axios from 'axios'

const API = 'https://api.apocalypse.web.id/download/play'

async function searchPlay(query, bitrate = 320) {
  const url = `${API}?q=${encodeURIComponent(query)}&bitrate=${bitrate}`
  const res = await axios.get(url)
  if (!res.data.status) throw 'Not Found'
  return res.data.result
}



async function handler(m, { sock, text }) {
  if (!text) return m.reply('Contoh:\n.play kabhi khusi | 320')

  try {

    let [query, br] = text.split('|').map(v => v.trim())
    let bitrate = br ? br : '320'

    await sock.sendMessage(m.chat, { react: { text: '⏳', key: m.key } })

    const data = await searchPlay(query, bitrate)

    await sock.sendMessage(m.chat, {
      audio: { url: data.download_url },
      mimetype: 'audio/mpeg',
      fileName: `${data.title}.mp3`,
      contextInfo: {
        externalAdReply: {
          title: data.title,
          body: `${data.channel} • ${bitrate}kbps`,
          thumbnailUrl: data.thumbnail,
          sourceUrl: 'https://youtube.com',
          mediaType: 1,
          renderLargerThumbnail: true
        }
      }
    }, { quoted: m })

    await sock.sendMessage(m.chat, { react: { text: '✅', key: m.key } })

  } catch (e) {
    await sock.sendMessage(m.chat, { react: { text: '❌', key: m.key } })
    m.reply('error bang')
  }
}

handler.help = ['play <judul> | <bitrate>']
handler.tags = ['music']
handler.command = /^play$/i

export default handler